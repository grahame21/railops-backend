name: Update trains.json (TrainFinder live)

on:
  workflow_dispatch:
  schedule:
    - cron: "*/1 * * * *" # every minute

jobs:
  update-trains:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch trains.json via curl (pass 1)
        env:
          COOKIE: ${{ secrets.TRAINFINDER_COOKIE_RAW }}
          URL: ${{ secrets.TRAINFINDER_VIEWPORT_URL }}
          REF: ${{ secrets.TRAINFINDER_REFERER }}
          UA: ${{ secrets.TRAINFINDER_UA }}
          METHOD: ${{ secrets.TRAINFINDER_METHOD }}
        run: |
          set -euo pipefail
          mkdir -p deploy
          METH="${METHOD:-POST}"
          echo "[info] ${METH} ${URL}"
          if [[ "$METH" == "GET" ]]; then
            curl --fail-with-body -sS \
              -X GET "$URL" \
              -H 'accept: */*' \
              -H "referer: ${REF:-https://trainfinder.otenko.com/home/nextlevel}" \
              -H 'x-requested-with: XMLHttpRequest' \
              -H "origin: https://trainfinder.otenko.com" \
              -H "user-agent: ${UA:-Mozilla/5.0 (TrainTracker/2.0)}" \
              -b "$COOKIE" \
              -o deploy/trains.json
          else
            curl --fail-with-body -sS \
              -X POST "$URL" \
              -H 'accept: */*' \
              -H "referer: ${REF:-https://trainfinder.otenko.com/home/nextlevel}" \
              -H 'x-requested-with: XMLHttpRequest' \
              -H "origin: https://trainfinder.otenko.com" \
              -H "user-agent: ${UA:-Mozilla/5.0 (TrainTracker/2.0)}" \
              -b "$COOKIE" \
              --data-raw '' \
              -o deploy/trains.json
          fi
          head -c 400 deploy/trains.json | tr -d '\n' || true; echo
          cat > deploy/_headers <<'H'
          /trains.json
            Cache-Control: no-store, no-cache, must-revalidate, max-age=0
            Pragma: no-cache
            Expires: 0
            Access-Control-Allow-Origin: *
            Access-Control-Allow-Methods: GET, OPTIONS
            Access-Control-Allow-Headers: *
          H

      - name: Wait 30 seconds
        run: sleep 30

      - name: Fetch trains.json via curl (pass 2)
        env:
          COOKIE: ${{ secrets.TRAINFINDER_COOKIE_RAW }}
          URL: ${{ secrets.TRAINFINDER_VIEWPORT_URL }}
          REF: ${{ secrets.TRAINFINDER_REFERER }}
          UA: ${{ secrets.TRAINFINDER_UA }}
          METHOD: ${{ secrets.TRAINFINDER_METHOD }}
        run: |
          set -euo pipefail
          METH="${METHOD:-POST}"
          echo "[info] ${METH} ${URL}"
          if [[ "$METH" == "GET" ]]; then
            curl --fail-with-body -sS \
              -X GET "$URL" \
              -H 'accept: */*' \
              -H "referer: ${REF:-https://trainfinder.otenko.com/home/nextlevel}" \
              -H 'x-requested-with: XMLHttpRequest' \
              -H "origin: https://trainfinder.otenko.com" \
              -H "user-agent: ${UA:-Mozilla/5.0 (TrainTracker/2.0)}" \
              -b "$COOKIE" \
              -o deploy/trains.json
          else
            curl --fail-with-body -sS \
              -X POST "$URL" \
              -H 'accept: */*' \
              -H "referer: ${REF:-https://trainfinder.otenko.com/home/nextlevel}" \
              -H 'x-requested-with: XMLHttpRequest' \
              -H "origin: https://trainfinder.otenko.com" \
              -H "user-agent: ${UA:-Mozilla/5.0 (TrainTracker/2.0)}" \
              -b "$COOKIE" \
              --data-raw '' \
              -o deploy/trains.json
          fi
          head -c 400 deploy/trains.json | tr -d '\n' || true; echo

      - name: Deploy to Netlify
        uses: nwtgck/actions-netlify@v2
        with:
          publish-dir: deploy
          production-deploy: true
          deploy-message: "Update trains.json"
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
