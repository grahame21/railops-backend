name: Update trains.json (TrainFinder live)

on:
  schedule:
    - cron: "*/1 * * * *"   # every minute
  workflow_dispatch: {}

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    env:
      DATA_SITE_NAME: traintracker2-0-data   # change if this subdomain is taken

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install requests

      # Quick sanity to ensure the script is present
      - name: Show first lines of scripts/fetch_trains.py
        run: |
          sed -n '1,40p' scripts/fetch_trains.py

      # Optional but useful: verify cookie is valid
      - name: Check TrainFinder auth
        env:
          TRAINFINDER_COOKIE_RAW: ${{ secrets.TRAINFINDER_COOKIE_RAW }}
        run: |
          python - << 'PY'
          import os, requests
          cookie = os.environ.get("TRAINFINDER_COOKIE_RAW","").strip()
          if not cookie:
            raise SystemExit("No TRAINFINDER_COOKIE_RAW set")
          h = {
            "x-requested-with":"XMLHttpRequest",
            "referer":"https://trainfinder.otenko.com/home/nextlevel",
            "user-agent":"Mozilla/5.0 TrainTracker/2.0"
          }
          h["Cookie"] = cookie
          r = requests.post("https://trainfinder.otenko.com/Home/IsLoggedIn", headers=h, timeout=20)
          print("IsLoggedIn status:", r.status_code, "body:", r.text[:120])
          PY

      - name: First fetch -> deploy/trains.json
        env:
          TRAINFINDER_VIEWPORT_URL: ${{ secrets.TRAINFINDER_VIEWPORT_URL }}
          TRAINFINDER_METHOD: ${{ secrets.TRAINFINDER_METHOD }}
          TRAINFINDER_POST_BODY: ${{ secrets.TRAINFINDER_POST_BODY }}
          TRAINFINDER_HEADERS_JSON: ${{ secrets.TRAINFINDER_HEADERS_JSON }}
          TRAINFINDER_COOKIE_RAW: ${{ secrets.TRAINFINDER_COOKIE_RAW }}
          TRAINFINDER_ASPXAUTH: ${{ secrets.TRAINFINDER_ASPXAUTH }}
        run: |
          python scripts/fetch_trains.py

      - name: Wait 30 seconds
        run: sleep 30

      - name: Second fetch -> update file again
        env:
          TRAINFINDER_VIEWPORT_URL: ${{ secrets.TRAINFINDER_VIEWPORT_URL }}
          TRAINFINDER_METHOD: ${{ secrets.TRAINFINDER_METHOD }}
          TRAINFINDER_POST_BODY: ${{ secrets.TRAINFINDER_POST_BODY }}
          TRAINFINDER_HEADERS_JSON: ${{ secrets.TRAINFINDER_HEADERS_JSON }}
          TRAINFINDER_COOKIE_RAW: ${{ secrets.TRAINFINDER_COOKIE_RAW }}
          TRAINFINDER_ASPXAUTH: ${{ secrets.TRAINFINDER_ASPXAUTH }}
        run: |
          python scripts/fetch_trains.py

      - name: Setup Node + tools
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Netlify CLI + jq
        run: |
          npm i -g netlify-cli
          sudo apt-get update -y && sudo apt-get install -y jq

      - name: Ensure data site exists (with team context)
        id: ensure_site
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          DATA_SITE_NAME: ${{ env.DATA_SITE_NAME }}
        run: |
          set -e
          USER_JSON=$(netlify api getCurrentUser)
          TEAM_SLUG=$(echo "$USER_JSON" | jq -r '.memberships[0].account.slug')
          echo "Team slug: $TEAM_SLUG"

          SITE_JSON=$(netlify api listSites --data '{ "page": 1, "per_page": 1000 }')
          SITE_ID=$(echo "$SITE_JSON" | jq -r '.[] | select(.name=="'"$DATA_SITE_NAME"'") | .id' | head -n1)

          if [ -z "$SITE_ID" ] || [ "$SITE_ID" = "null" ]; then
            echo "Creating site $DATA_SITE_NAME under team $TEAM_SLUG..."
            CREATE_JSON=$(netlify api createSite --data '{ "account_slug": "'"$TEAM_SLUG"'", "name": "'"$DATA_SITE_NAME"'" }')
            SITE_ID=$(echo "$CREATE_JSON" | jq -r '.id')
          else
            echo "Found existing site: $SITE_ID"
          fi

          if [ -z "$SITE_ID" ] || [ "$SITE_ID" = "null" ]; then
            echo "Failed to get/create site." >&2
            exit 1
          fi

          echo "site_id=$SITE_ID" >> "$GITHUB_OUTPUT"

      - name: Get actual site URL (print it)
        id: site_info
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        run: |
          SITE_ID="${{ steps.ensure_site.outputs.site_id }}"
          INFO=$(netlify api getSite --data '{ "site_id": "'"$SITE_ID"'" }')
          echo "$INFO" | jq -r '{name, url, ssl_url}'
          echo "ssl_url=$(echo "$INFO" | jq -r .ssl_url)" >> "$GITHUB_OUTPUT"

      - name: Deploy trains.json to data site (prod)
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ steps.ensure_site.outputs.site_id }}
        run: |
          netlify deploy --dir deploy --prod --message "auto: $GITHUB_RUN_ID-$GITHUB_RUN_NUMBER"

      - name: Print final data URL
        run: |
          echo "Data file:"
          echo "${{ steps.site_info.outputs.ssl_url }}/trains.json"
