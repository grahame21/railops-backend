name: Update trains.json (TrainFinder live, replay from Chrome)

on:
  workflow_dispatch:
  schedule:
    - cron: "*/5 * * * *"    # every 5 minutes

jobs:
  update-trains:
    runs-on: ubuntu-latest
    timeout-minutes: 6

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y curl
          npm i -g netlify-cli

      # Replays the exact request you captured in Chrome.
      # Uses your secrets for the cookie and referer so you can update them without editing YAML.
      - name: Fetch trains.json (exact Chrome headers; empty-body POST)
        env:
          COOKIE: ${{ secrets.TRAINFINDER_COOKIE_RAW }}     # set this to the .ASPXAUTH=... value you copied
          REF: ${{ secrets.TRAINFINDER_REFERER }}           # set to your captured referer URL (with lat,lng,zm)
        run: |
          set -e
          mkdir -p deploy
          URL='https://trainfinder.otenko.com/Home/GetViewPortData'
          echo "[info] POST $URL"
          CODE=$(curl -sS -o deploy/trains.json -w "%{http_code}" \
            -X POST "$URL" \
            -H 'accept: */*' \
            -H 'accept-language: en-GB,en-US;q=0.9,en;q=0.8' \
            -H 'content-length: 0' \
            -H 'origin: https://trainfinder.otenko.com' \
            -H 'priority: u=1, i' \
            -H "referer: ${REF}" \
            -H 'sec-ch-ua: "Not;A=Brand";v="99", "Google Chrome";v="139", "Chromium";v="139"' \
            -H 'sec-ch-ua-mobile: ?0' \
            -H 'sec-ch-ua-platform: "Windows"' \
            -H 'sec-fetch-dest: empty' \
            -H 'sec-fetch-mode: cors' \
            -H 'sec-fetch-site: same-origin' \
            -H 'user-agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.0.0 Safari/537.36' \
            -H 'x-requested-with: XMLHttpRequest' \
            -b "$COOKIE" \
            --data-raw '')

          echo "[POST] HTTP $CODE  $(head -c 220 deploy/trains.json | tr -d '\n')"
          test "$CODE" -ge 200 -a "$CODE" -lt 400

          # Basic sanity checks
          if grep -qi '<html' deploy/trains.json; then
            echo "::error::Server returned HTML (probably cookie expired). Update TRAINFINDER_COOKIE_RAW."; exit 1
          fi
          if grep -q '"favs":null' deploy/trains.json; then
            echo "::warning::Null payload. Try a different viewport in TRAINFINDER_REFERER (zm ~ 6-7 usually works better)."
          fi

          # Netlify headers (CORS + no-cache)
          cat > deploy/_headers <<'H'
          /trains.json
            Cache-Control: no-store, no-cache, must-revalidate, max-age=0
            Pragma: no-cache
            Expires: 0
            Access-Control-Allow-Origin: *
            Access-Control-Allow-Methods: GET, OPTIONS
            Access-Control-Allow-Headers: *
          H

      - name: Deploy trains.json to Netlify (prod)
        uses: nwtgck/actions-netlify@v2
        with:
          publish-dir: ./deploy
          production-branch: main
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "Automated update trains.json"
          enable-pull-request-comment: false
          enable-commit-comment: false
          overwrites-pull-request-comment: true
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
